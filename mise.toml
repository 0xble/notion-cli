[tools]
go = "1.25"
golangci-lint = "2"
svu = "3"

[tasks.build]
description = "Build the binary"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
go build -ldflags "-X main.version=$VERSION" -o notion-cli .
"""

[tasks.install]
description = "Build and install to ~/bin"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
go build -ldflags "-X main.version=$VERSION" -o ~/bin/notion-cli .
"""

[tasks.test]
description = "Run tests"
run = "go test -v ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks.clean]
description = "Clean build artifacts"
run = """
rm -f notion-cli
rm -rf dist/
"""

[tasks.check]
description = "Run all checks (build, test, lint)"
depends = ["build", "test", "lint"]

[tasks.install-skill]
description = "Install the Amp skill globally"
run = """
mkdir -p ~/.config/agents/skills/notion
cp skills/notion/SKILL.md ~/.config/agents/skills/notion/SKILL.md
echo "Installed skill to ~/.config/agents/skills/notion/"
"""

[tasks.release]
description = "Tag a fork version (-0xble.major.minor.patch) and push to trigger a release"
depends = ["check"]
run = """
if [ -z "${1:-}" ]; then
  echo "Usage: mise run release <major.minor.patch>"
  echo "Example: mise run release 1.5.5"
  exit 1
fi

git fetch upstream --tags >/dev/null 2>&1 || true
git fetch origin --tags >/dev/null 2>&1 || true

UPSTREAM_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || git describe --tags --abbrev=0)
BASE_TAG=${UPSTREAM_TAG%%-0xble.*}
NEXT="${BASE_TAG}-0xble.${1}"

echo "Releasing fork tag: $NEXT (base upstream: $BASE_TAG)"
git tag "$NEXT"
git push origin "$NEXT"
echo "Tagged and pushed $NEXT â€” release workflow will run on GitHub."
"""
